name: Deploy to Manitu (FTPS)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via FTPS
        env:
          HOST: ${{ secrets.MANITU_HOST }}
          USER: ${{ secrets.MANITU_USER }}
          PASS: ${{ secrets.MANITU_PASS }}
          REMOTE: ${{ secrets.MANITU_PATH }}
        run: |
          lftp -u "$USER","$PASS" "ftp://$HOST:21" -e "
            set ftp:passive-mode true;
            set ftp:ssl-auth TLS;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set net:max-retries 3;
            set net:timeout 30;
            mirror -R --only-newer --parallel=2 \
              --exclude-glob .git/ \
              --exclude-glob .git/** \
              --exclude-glob .github/ \
              --exclude-glob .github/** \
              --exclude-glob .DS_Store \
              --exclude-glob test.php \
              --exclude-glob test2.php \
              --exclude-glob public/debug.php \
              --exclude-glob router.php \
              --exclude-glob data/users.json \
              --exclude-glob data/feeds/*.json \
              --exclude-glob data/audio/*/* \
              --exclude-glob data/images/*.jpg \
              --exclude-glob data/images/*.png \
              --exclude-glob data/images/*.webp \
              . $REMOTE;
            bye
          "
